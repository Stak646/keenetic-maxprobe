#!/bin/sh
# keenetic-maxprobe — maximal KeeneticOS + Entware probe
# Version: 0.7.5
# Fixes: no tr() shadowing; wizard y/n stable; metrics stops; output in /var/tmp; /var/tmp excluded.

set -u
umask 077
PATH="/opt/bin:/opt/sbin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
VERSION="0.7.5"
PROG="keenetic-maxprobe"

LANG_UI="${LANG_UI:-ru}"
PROFILE="${PROFILE:-auto}"
MODE="${MODE:-full}"
COLLECTORS="${COLLECTORS:-all}"
CUSTOM_COLLECTORS="${CUSTOM_COLLECTORS:-}"
YES="${YES:-0}"

OUTBASE="/var/tmp"
CLEAN_OLD="${CLEAN_OLD:-0}"
CLEAN_TMP="${CLEAN_TMP:-0}"
DEBUG="${DEBUG:-1}"
SPINNER="${SPINNER:-1}"

NO_INSTALL="${NO_INSTALL:-0}"
DEPS_MODE="${DEPS_MODE:-cleanup}"
DEPS_LEVEL="${DEPS_LEVEL:-core}"
INSTALLED_TOP_PKGS=""

MAX_CPU="${MAX_CPU:-85}"
MAX_MEM="${MAX_MEM:-95}"
JOBS="${JOBS:-auto}"

WEB=0
WEB_BIND="${WEB_BIND:-127.0.0.1}"
WEB_PORT="${WEB_PORT:-8088}"

INIT=0
CONFIG_PATH="/opt/etc/keenetic-maxprobe.conf"
COLLECTORS_DIR="/opt/share/keenetic-maxprobe/collectors"

BASE=""
WORK=""
ARCHIVE=""
RUNLOG=""
ERRLOG=""
PHASE_FILE=""
PROGRESS_FILE=""
METRICS_TSV=""
METRICS_CUR=""
METRICS_PID=""
SPINNER_PID=""
KEEP_WORK="${KMP_KEEP_WORK:-0}"

T() {
  key="$1"
  case "${LANG_UI:-ru}" in
    en)
      case "$key" in
        WIZ_TITLE) echo "== keenetic-maxprobe init wizard ==" ;;
        WIZ_LANG) echo "UI language: ru/en" ;;
        WIZ_PROFILE_HELP) echo "auto=smart; forensic=max; diagnostic=balanced; lite=min" ;;
        WIZ_PROFILE) echo "Profile: auto/forensic/diagnostic/lite" ;;
        WIZ_MODE_HELP) echo "full=max data; safe=redaction guide; extream=deepest" ;;
        WIZ_MODE) echo "Mode: full/safe/extream" ;;
        WIZ_COLLECTORS_HELP) echo "all=all; shonly=shell; shpy=shell+python; custom=list" ;;
        WIZ_COLLECTORS) echo "Collectors: all/shonly/shpy/custom" ;;
        WIZ_CUSTOM) echo "Custom collectors (py,go,lua,node,perl,ruby)" ;;
        WIZ_OUTDIR_FIXED) echo "Output directory is fixed by policy: /var/tmp" ;;
        WIZ_CLEAN_OLD) echo "Clean old keenetic-maxprobe-* archives in /var/tmp?" ;;
        WIZ_CLEAN_TMP) echo "Clean /tmp before run?" ;;
        WIZ_DEBUG) echo "Enable debug?" ;;
        WIZ_DEPS_CLEANUP) echo "Cleanup temporarily installed packages after run?" ;;
        WIZ_DEPS_LEVEL) echo "Install missing runtimes (python/node/...) in extream?" ;;
        WIZ_SPINNER) echo "Show spinner?" ;;
        WIZ_LIMITS_CPU) echo "CPU limit (%)" ;;
        WIZ_LIMITS_MEM) echo "RAM limit (%)" ;;
        WIZ_JOBS) echo "Jobs (auto/1/2/...)" ;;
        SAVED) echo "[+] Saved:" ;;
        STARTING) echo "[+] Starting probe" ;;
        DONE) echo "[+] Done. Archive:" ;;
        *) echo "$key" ;;
      esac ;;
    *)
      case "$key" in
        WIZ_TITLE) echo "== мастер настройки keenetic-maxprobe ==" ;;
        WIZ_LANG) echo "Язык интерфейса: ru/en" ;;
        WIZ_PROFILE_HELP) echo "auto=умно; forensic=максимум; diagnostic=баланс; lite=минимум" ;;
        WIZ_PROFILE) echo "Профиль: auto/forensic/diagnostic/lite" ;;
        WIZ_MODE_HELP) echo "full=максимум; safe=гид по скрытию; extream=максимум" ;;
        WIZ_MODE) echo "Режим: full/safe/extream" ;;
        WIZ_COLLECTORS_HELP) echo "all=все; shonly=shell; shpy=shell+python; custom=список" ;;
        WIZ_COLLECTORS) echo "Collectors: all/shonly/shpy/custom" ;;
        WIZ_CUSTOM) echo "Список collectors (py,go,lua,node,perl,ruby)" ;;
        WIZ_OUTDIR_FIXED) echo "Папка вывода зафиксирована политикой: /var/tmp" ;;
        WIZ_CLEAN_OLD) echo "Удалить старые keenetic-maxprobe-* архивы в /var/tmp?" ;;
        WIZ_CLEAN_TMP) echo "Очистить /tmp перед запуском?" ;;
        WIZ_DEBUG) echo "Включить debug?" ;;
        WIZ_DEPS_CLEANUP) echo "Удалять временные пакеты после запуска?" ;;
        WIZ_DEPS_LEVEL) echo "Ставить runtimes collectors (python/node/...) в extream?" ;;
        WIZ_SPINNER) echo "Показывать анимацию?" ;;
        WIZ_LIMITS_CPU) echo "Лимит CPU (%)" ;;
        WIZ_LIMITS_MEM) echo "Лимит RAM (%)" ;;
        WIZ_JOBS) echo "Параллельность (auto/1/2/...)" ;;
        SAVED) echo "[+] Сохранено:" ;;
        STARTING) echo "[+] Старт диагностики" ;;
        DONE) echo "[+] Готово. Архив:" ;;
        *) echo "$key" ;;
      esac ;;
  esac
}

have(){ command -v "$1" >/dev/null 2>&1; }
now_utc(){ date -u '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date '+%Y-%m-%dT%H:%M:%SZ'; }
ts_utc_path(){ date -u '+%Y%m%dT%H%M%SZ' 2>/dev/null || date '+%Y%m%dT%H%M%SZ'; }
ensure_dir(){ [ -d "$1" ] || mkdir -p "$1" 2>/dev/null || return 1; }
strip_ws(){ printf '%s' "${1:-}" | command tr -d '\r' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//'; }
lower_first(){ s="$(strip_ws "$1")"; s="$(printf '%s' "$s" | command tr '[:upper:]' '[:lower:]')"; printf '%s' "$s" | cut -c1; }
say(){ ts="$(now_utc)"; printf '%s %s\n' "$ts" "$*" >&2; [ -n "${RUNLOG:-}" ] && printf '%s %s\n' "$ts" "$*" >>"$RUNLOG" 2>/dev/null || true; }
warn(){ ts="$(now_utc)"; printf '%s [!] %s\n' "$ts" "$*" >&2; [ -n "${ERRLOG:-}" ] && printf '%s [!] %s\n' "$ts" "$*" >>"$ERRLOG" 2>/dev/null || true; }
die(){ warn "$*"; exit 1; }

ask(){
  prompt="$1"; def="$2"
  if [ "$YES" -eq 1 ] 2>/dev/null; then printf '%s' "$def"; return 0; fi
  printf '%s [%s]: ' "$prompt" "$def" >&2
  IFS= read -r ans || ans=""
  ans="$(strip_ws "$ans")"; [ -n "$ans" ] || ans="$def"
  printf '%s' "$ans"
}
ask_yn(){
  prompt="$1"; def="$2"
  if [ "$YES" -eq 1 ] 2>/dev/null; then [ "$def" = "y" ] && return 0 || return 1; fi
  while :; do
    ans="$(ask "$prompt (y/n)" "$def")"
    a="$(lower_first "$ans")"
    case "$a" in y) return 0 ;; n) return 1 ;; esac
  done
}

load_config(){
  [ -f "$CONFIG_PATH" ] || return 0
  . "$CONFIG_PATH" 2>/dev/null || true
  LANG_UI="$(strip_ws "${LANG_UI:-ru}")"
  PROFILE="$(strip_ws "${PROFILE:-auto}")"
  MODE="$(strip_ws "${MODE:-full}")"
  COLLECTORS="$(strip_ws "${COLLECTORS:-all}")"
  CUSTOM_COLLECTORS="$(strip_ws "${CUSTOM_COLLECTORS:-}")"
  CLEAN_OLD="$(strip_ws "${CLEAN_OLD:-0}")"
  CLEAN_TMP="$(strip_ws "${CLEAN_TMP:-0}")"
  DEBUG="$(strip_ws "${DEBUG:-1}")"
  SPINNER="$(strip_ws "${SPINNER:-1}")"
  NO_INSTALL="$(strip_ws "${NO_INSTALL:-0}")"
  DEPS_MODE="$(strip_ws "${DEPS_MODE:-cleanup}")"
  DEPS_LEVEL="$(strip_ws "${DEPS_LEVEL:-core}")"
  MAX_CPU="$(strip_ws "${MAX_CPU:-85}")"
  MAX_MEM="$(strip_ws "${MAX_MEM:-95}")"
  JOBS="$(strip_ws "${JOBS:-auto}")"
}
save_config(){
  ensure_dir "$(dirname "$CONFIG_PATH")" || true
  cat >"$CONFIG_PATH" <<EOF
LANG_UI=$LANG_UI
PROFILE=$PROFILE
MODE=$MODE
COLLECTORS=$COLLECTORS
CUSTOM_COLLECTORS=$CUSTOM_COLLECTORS
CLEAN_OLD=$CLEAN_OLD
CLEAN_TMP=$CLEAN_TMP
DEBUG=$DEBUG
SPINNER=$SPINNER
NO_INSTALL=$NO_INSTALL
DEPS_MODE=$DEPS_MODE
DEPS_LEVEL=$DEPS_LEVEL
MAX_CPU=$MAX_CPU
MAX_MEM=$MAX_MEM
JOBS=$JOBS
EOF
}

usage(){
  cat >&2 <<EOF
$PROG $VERSION
Policy: output in /var/tmp; /var/tmp excluded from scanning
EOF
}
parse_args(){
  while [ $# -gt 0 ]; do
    case "$1" in
      --init) INIT=1 ;;
      --lang) LANG_UI="${2:-ru}"; shift ;;
      --profile) PROFILE="${2:-auto}"; shift ;;
      --mode) MODE="${2:-full}"; shift ;;
      --extream|--extreme) MODE="extream" ;;
      --collectors) COLLECTORS="${2:-all}"; shift ;;
      --custom-collectors) CUSTOM_COLLECTORS="${2:-}"; COLLECTORS="custom"; shift ;;
      --clean-old) CLEAN_OLD=1 ;;
      --clean-tmp) CLEAN_TMP=1 ;;
      --no-spinner) SPINNER=0 ;;
      -y|--yes) YES=1 ;;
      --deps-level) DEPS_LEVEL="${2:-core}"; shift ;;
      --web) WEB=1 ;;
      --web-bind) WEB_BIND="${2:-127.0.0.1}"; shift ;;
      --web-port) WEB_PORT="${2:-8088}"; shift ;;
      -h|--help) usage; exit 0 ;;
      *) warn "Unknown arg: $1"; usage; exit 2 ;;
    esac
    shift
  done
}

mem_used_pct(){
  mt="$(awk '/MemTotal:/{print $2}' /proc/meminfo 2>/dev/null || echo 0)"
  ma="$(awk '/MemAvailable:/{print $2}' /proc/meminfo 2>/dev/null || echo 0)"
  [ "$mt" -gt 0 ] 2>/dev/null || { echo 0; return; }
  [ "$ma" -gt 0 ] 2>/dev/null || ma="$(awk '/MemFree:/{print $2}' /proc/meminfo 2>/dev/null || echo 0)"
  used=$((mt-ma))
  pct=$(( (100*used)/mt )); [ "$pct" -lt 0 ] && pct=0; [ "$pct" -gt 100 ] && pct=100
  echo "$pct"
}
cpu_sample(){
  set -- $(awk '/^cpu /{print $2,$3,$4,$5,$6,$7,$8,$9}' /proc/stat 2>/dev/null)
  u="${1:-0}"; n="${2:-0}"; s="${3:-0}"; i="${4:-0}"; w="${5:-0}"; irq="${6:-0}"; sirq="${7:-0}"; st="${8:-0}"
  total=$((u+n+s+i+w+irq+sirq+st)); idle=$((i+w))
  printf '%s %s\n' "$total" "$idle"
}
start_metrics(){
  [ "$DEBUG" -eq 1 ] 2>/dev/null || return 0
  METRICS_TSV="$WORK/meta/metrics.tsv"
  METRICS_CUR="$WORK/meta/metrics_current.tsv"
  printf 'ts_utc\tcpu_pct\tmem_used_pct\tload1\n' >"$METRICS_TSV" 2>/dev/null || true
  : >"$METRICS_CUR" 2>/dev/null || true
  (
    prev="$(cpu_sample)"; pt="${prev% *}"; pi="${prev#* }"
    while :; do
      cur="$(cpu_sample)"; ct="${cur% *}"; ci="${cur#* }"
      dt=$((ct-pt)); di=$((ci-pi)); pt="$ct"; pi="$ci"
      if [ "$dt" -le 0 ] 2>/dev/null; then cpu=0; else used=$((dt-di)); cpu=$(( (100*used)/dt )); fi
      [ "$cpu" -lt 0 ] && cpu=0; [ "$cpu" -gt 100 ] && cpu=100
      mem="$(mem_used_pct)"; l1="$(awk '{print $1}' /proc/loadavg 2>/dev/null || echo 0)"; ts="$(now_utc)"
      [ -d "$WORK/meta" ] || exit 0
      printf '%s\t%s\t%s\t%s\n' "$ts" "$cpu" "$mem" "$l1" >>"$METRICS_TSV" 2>/dev/null || true
      printf '%s\t%s\t%s\t%s\n' "$ts" "$cpu" "$mem" "$l1" >"$METRICS_CUR" 2>/dev/null || true
      sleep 2
    done
  ) &
  METRICS_PID="$!"
}
stop_metrics(){ [ -n "${METRICS_PID:-}" ] || return 0; kill "$METRICS_PID" 2>/dev/null || true; wait "$METRICS_PID" 2>/dev/null || true; METRICS_PID=""; }

start_spinner(){
  [ "$SPINNER" -eq 1 ] 2>/dev/null || return 0
  (
    i=0; chars='|/-\'
    while :; do
      i=$(( (i+1)%4 )); ch="$(printf '%s' "$chars" | cut -c $((i+1)))"
      ph="$(cat "$PHASE_FILE" 2>/dev/null | head -n1)"
      cur="$(cat "$METRICS_CUR" 2>/dev/null | tail -n1)"
      cpu="$(printf '%s' "$cur" | awk -F'\t' '{print $2}' 2>/dev/null)"
      mem="$(printf '%s' "$cur" | awk -F'\t' '{print $3}' 2>/dev/null)"
      l1="$(printf '%s' "$cur" | awk -F'\t' '{print $4}' 2>/dev/null)"
      [ -n "$cpu" ] && cpu="CPU~${cpu}%"; [ -n "$mem" ] && mem="RAM~${mem}%"; [ -n "$l1" ] && l1="L1~${l1}"
      printf '\r[%s]  %s  %s %s %s  ' "$ch" "$ph" "$cpu" "$mem" "$l1" >&2
      sleep 1
    done
  ) &
  SPINNER_PID="$!"
}
stop_spinner(){ [ -n "${SPINNER_PID:-}" ] || return 0; kill "$SPINNER_PID" 2>/dev/null || true; wait "$SPINNER_PID" 2>/dev/null || true; SPINNER_PID=""; printf '\n' >&2; }

opkg_have(){ opkg status "$1" >/dev/null 2>&1; }
opkg_install_top(){ pkg="$1"; [ "$NO_INSTALL" -eq 0 ] 2>/dev/null || return 1; opkg_have "$pkg" && return 0; opkg install "$pkg" >/dev/null 2>&1 && { INSTALLED_TOP_PKGS="$INSTALLED_TOP_PKGS $pkg"; return 0; } || return 1; }
deps_prepare(){
  have opkg || return 0
  opkg update >/dev/null 2>&1 || true
  opkg_install_top ca-bundle || true
  opkg_install_top curl || opkg_install_top wget-ssl || opkg_install_top wget-nossl || true
  opkg_install_top tar || true
  opkg_install_top gzip || true
  if [ "$MODE" = "extream" ] && [ "$DEPS_LEVEL" = "collectors" ]; then
    opkg_install_top python3 || opkg_install_top python3-light || true
  fi
}
deps_cleanup(){
  have opkg || return 0
  [ "$DEPS_MODE" = "cleanup" ] || return 0
  for p in $INSTALLED_TOP_PKGS; do [ -n "$p" ] || continue; opkg remove "$p" >/dev/null 2>&1 || true; done
}

init_wizard(){
  echo ""; echo "$(T WIZ_TITLE)"; echo ""
  lang="$(ask "$(T WIZ_LANG)" "$LANG_UI")"; case "$lang" in ru|en) LANG_UI="$lang";; esac
  echo ""; echo "$(T WIZ_PROFILE_HELP)"; p="$(ask "$(T WIZ_PROFILE)" "$PROFILE")"; case "$p" in auto|forensic|diagnostic|lite) PROFILE="$p";; esac
  echo ""; echo "$(T WIZ_MODE_HELP)"; m="$(ask "$(T WIZ_MODE)" "$MODE")"; case "$m" in full|safe|extream) MODE="$m";; esac
  echo ""; echo "$(T WIZ_COLLECTORS_HELP)"; c="$(ask "$(T WIZ_COLLECTORS)" "$COLLECTORS")"; case "$c" in all|shonly|shpy|custom) COLLECTORS="$c";; esac
  if [ "$COLLECTORS" = "custom" ]; then CUSTOM_COLLECTORS="$(ask "$(T WIZ_CUSTOM)" "$CUSTOM_COLLECTORS")"; fi
  echo "$(T WIZ_OUTDIR_FIXED)"
  ask_yn "$(T WIZ_CLEAN_OLD)" "n" && CLEAN_OLD=1 || CLEAN_OLD=0
  ask_yn "$(T WIZ_CLEAN_TMP)" "n" && CLEAN_TMP=1 || CLEAN_TMP=0
  ask_yn "$(T WIZ_DEBUG)" "y" && DEBUG=1 || DEBUG=0
  ask_yn "$(T WIZ_DEPS_CLEANUP)" "y" && DEPS_MODE="cleanup" || DEPS_MODE="keep"
  ask_yn "$(T WIZ_SPINNER)" "y" && SPINNER=1 || SPINNER=0
  MAX_CPU="$(ask "$(T WIZ_LIMITS_CPU)" "$MAX_CPU")"
  MAX_MEM="$(ask "$(T WIZ_LIMITS_MEM)" "$MAX_MEM")"
  JOBS="$(ask "$(T WIZ_JOBS)" "$JOBS")"
  if [ "$MODE" = "extream" ]; then ask_yn "$(T WIZ_DEPS_LEVEL)" "n" && DEPS_LEVEL="collectors" || DEPS_LEVEL="core"; fi
  save_config
  echo "$(T SAVED) $CONFIG_PATH"
}

setup_workdir(){
  ensure_dir "$OUTBASE" || die "Cannot create $OUTBASE"
  host="$(hostname 2>/dev/null | head -n1)"; [ -n "$host" ] || host="router"
  ts="$(ts_utc_path)"; pid="$$"
  BASE="keenetic-maxprobe-${host}-${pid}-${ts}"
  WORK="$OUTBASE/${BASE}.work"
  ARCHIVE="$OUTBASE/${BASE}.tar.gz"
  ensure_dir "$WORK/meta" || die "Cannot create meta"
  ensure_dir "$WORK/sys" || true
  ensure_dir "$WORK/net" || true
  ensure_dir "$WORK/entware" || true
  ensure_dir "$WORK/ndm" || true
  ensure_dir "$WORK/web" || true
  ensure_dir "$WORK/fs" || true
  RUNLOG="$WORK/meta/run.log"; ERRLOG="$WORK/meta/errors.log"
  PHASE_FILE="$WORK/meta/phase.txt"; PROGRESS_FILE="$WORK/meta/progress.txt"
  : >"$RUNLOG" 2>/dev/null || true; : >"$ERRLOG" 2>/dev/null || true
  printf '%s\n' "$VERSION" >"$WORK/meta/version.txt" 2>/dev/null || true
  printf '%s\n' "$PROFILE" >"$WORK/meta/profile.txt" 2>/dev/null || true
  printf '%s\n' "$MODE" >"$WORK/meta/mode.txt" 2>/dev/null || true
  printf '%s\n' "$(now_utc)" >"$WORK/meta/started_utc.txt" 2>/dev/null || true
}
cleanup_workdir(){
  stop_spinner; stop_metrics
  if [ "$KEEP_WORK" = "1" ]; then warn "KMP_KEEP_WORK=1, leaving WORKDIR: $WORK"; return 0; fi
  [ -n "${WORK:-}" ] || return 0
  rm -rf "$WORK" 2>/dev/null || true
}
clean_old_archives(){ [ "$CLEAN_OLD" -eq 1 ] 2>/dev/null || return 0; rm -f "$OUTBASE"/keenetic-maxprobe-*.tar.gz "$OUTBASE"/keenetic-maxprobe-*.tar.gz.sha256 2>/dev/null || true; }
clean_tmp_runs(){ [ "$CLEAN_TMP" -eq 1 ] 2>/dev/null || return 0; rm -rf /tmp/keenetic-maxprobe-* 2>/dev/null || true; }
phase(){ printf '%s\n' "$1" >"$PHASE_FILE" 2>/dev/null || true; }

collect_system(){
  phase "Sys: base inventory"
  uname -a >"$WORK/sys/uname.txt" 2>/dev/null || true
  cat /proc/cpuinfo >"$WORK/sys/proc_cpuinfo.txt" 2>/dev/null || true
  cat /proc/meminfo >"$WORK/sys/proc_meminfo.txt" 2>/dev/null || true
  df -h >"$WORK/sys/df_h.txt" 2>/dev/null || true
  mount >"$WORK/sys/mount.txt" 2>/dev/null || true
  ps w >"$WORK/sys/ps_w.txt" 2>/dev/null || true
}
collect_network(){
  phase "Net: sockets/routes"
  (ss -lntup 2>/dev/null || netstat -lntup 2>/dev/null || true) >"$WORK/net/listen.txt" 2>/dev/null || true
  (ip addr 2>/dev/null || ifconfig 2>/dev/null || true) >"$WORK/net/addr.txt" 2>/dev/null || true
  (ip route 2>/dev/null || route -n 2>/dev/null || true) >"$WORK/net/route.txt" 2>/dev/null || true
}
collect_entware(){
  phase "Entware: opkg"
  if have opkg; then
    opkg list-installed >"$WORK/entware/opkg_list_installed.txt" 2>/dev/null || true
    opkg status >"$WORK/entware/opkg_status.txt" 2>/dev/null || true
  fi
}
collect_ndm(){
  phase "KeeneticOS: ndmc"
  if have ndmc; then
    ndmc -c 'show version' >"$WORK/ndm/show_version.txt" 2>/dev/null || true
    ndmc -c 'show running-config' >"$WORK/ndm/show_running-config.txt" 2>/dev/null || true
  fi
}
collect_web_probe(){
  phase "Web: extended probe"
  have curl || return 0
  ports="80 443 79 78 8081 90 8088 2000 2222"
  host="127.0.0.1"
  out="$WORK/web/probe.tsv"
  printf 'host\tport\tscheme\tpath\tcode\tbytes\n' >"$out" 2>/dev/null || true
  for p in $ports; do
    for scheme in http https; do
      first="$(curl -skI --connect-timeout 1 --max-time 2 "${scheme}://${host}:${p}/" 2>/dev/null | head -n 1)"
      echo "$first" | grep -q '^HTTP/' || continue
      for path in / /robots.txt /metrics /swagger.json /openapi.json; do
        url="${scheme}://${host}:${p}${path}"
        bn="$(printf '%s' "$path" | sed 's|/|_|g; s/^_//')"
        body="$WORK/web/${host}_${p}_${scheme}_${bn}.body"
        hdr="$WORK/web/${host}_${p}_${scheme}_${bn}.headers"
        curl -sk --connect-timeout 1 --max-time 3 -D "$hdr" -o "$body" --range 0-262143 "$url" 2>/dev/null || true
        code="$(awk 'NR==1{print $2}' "$hdr" 2>/dev/null | head -n1)"; [ -n "$code" ] || code="000"
        bytes="$(wc -c <"$body" 2>/dev/null | sed 's/ //g')"; [ -n "$bytes" ] || bytes="0"
        printf '%s\t%s\t%s\t%s\t%s\t%s\n' "$host" "$p" "$scheme" "$path" "$code" "$bytes" >>"$out" 2>/dev/null || true
      done
    done
  done
}
mirror_basic(){
  phase "FS: configs mirror"
  for src in /etc /opt/etc /opt/var /storage/etc; do
    [ -d "$src" ] || continue
    (cd / && tar -cf - "${src#/}" 2>/dev/null) | (cd "$WORK/fs" && tar -xf - 2>/dev/null) || true
  done
  rm -rf "$WORK/fs/var/tmp" 2>/dev/null || true
}
mirror_extream(){
  phase "FS: extream mirror (/opt,/storage)"
  for src in /opt /storage /root; do
    [ -d "$src" ] || continue
    (cd / && tar -cf - "${src#/}" 2>/dev/null) | (cd "$WORK/fs" && tar -xf - 2>/dev/null) || true
  done
  rm -rf "$WORK/fs/var/tmp" 2>/dev/null || true
}
pack_archive(){
  phase "Packing: archive"
  (cd "$WORK" && tar -cf - . 2>/dev/null | gzip -1 >"$ARCHIVE") || die "Failed to create archive"
  if have sha256sum; then sha256sum "$ARCHIVE" >"$ARCHIVE.sha256" 2>/dev/null || true; fi
}
start_webui(){
  have python3 || die "python3 not found. Install: opkg update && opkg install python3"
  srv="$COLLECTORS_DIR/py/webui/server.py"; [ -f "$srv" ] || die "Web UI server not found: $srv"
  say "[+] Web UI: http://$WEB_BIND:$WEB_PORT/"
  exec python3 "$srv" --bind "$WEB_BIND" --port "$WEB_PORT" --probe-bin "/opt/bin/keenetic-maxprobe"
}

main(){
  load_config
  parse_args "$@"
  if [ "$INIT" -eq 1 ] 2>/dev/null; then init_wizard; exit 0; fi
  if [ "$WEB" -eq 1 ] 2>/dev/null; then start_webui; fi
  say "$(T STARTING)"
  deps_prepare
  clean_tmp_runs
  clean_old_archives
  setup_workdir
  start_metrics
  start_spinner
  collect_system
  collect_network
  collect_entware
  collect_ndm
  collect_web_probe
  if [ "$MODE" = "extream" ]; then mirror_extream; else mirror_basic; fi
  pack_archive
  stop_spinner
  stop_metrics
  deps_cleanup
  printf '%s
  %s
' "$(T DONE)" "$ARCHIVE" >&2
  cleanup_workdir
}

trap cleanup_workdir EXIT INT TERM
main "$@"
