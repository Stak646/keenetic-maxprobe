# keenetic-maxprobe — Документация (RU)

## Что это

`keenetic-maxprobe` — инструмент для **максимального сбора** технической информации с KeeneticOS + Entware (OPKG), чтобы:
- быстро диагностировать проблемы и баги;
- сделать «слепок» конфигов/хуков/сервисов для дальнейшего анализа;
- подготовить базу для Telegram‑бота, который будет управлять роутером и Entware‑службами.

Инструмент работает в стиле **best‑effort**: если какого‑то бинарника/команды нет — он пропускает шаг, но фиксирует это в отчёте.

## Важное про чувствительные данные

По умолчанию режим `FULL`: в архив могут попасть пароли, токены, ключи, приватные сертификаты, PPPoE‑данные, Wi‑Fi PSK и т.п.

Инструмент **не редактирует** эти данные, но:
- помечает потенциально чувствительные места в `analysis/SENSITIVE_LOCATIONS.md`;
- в `--mode safe` дополнительно старается не копировать наиболее «опасные» файлы (но это не 100% гарантия).

Перед тем как отправлять архив третьим лицам:
1) откройте `analysis/SENSITIVE_LOCATIONS.md`;
2) замаскируйте найденные строки/файлы;
3) (опционально) пересоберите архив.

## Установка (one‑liner)

```sh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/Stak646/keenetic-maxprobe/main/scripts/install.sh)"
```

После установки:
- бинарник: `/opt/bin/keenetic-maxprobe`
- коллекторы: `/opt/share/keenetic-maxprobe/collectors`

## Запуск

### Запуск по умолчанию

```sh
keenetic-maxprobe
```

### Инициализация (сохранить конфиг по умолчанию)

```sh
keenetic-maxprobe --init
```

Конфиг будет сохранён в `/opt/etc/keenetic-maxprobe.conf`.

### Примеры

Максимальная глубина:
```sh
keenetic-maxprobe --profile forensic --mode full
```

Быстрая диагностика:
```sh
keenetic-maxprobe --profile diagnostic --mode safe
```

Без очистки временной папки после (для ручного просмотра сырых файлов):
```sh
keenetic-maxprobe --no-cleanup
```

## Профили (включая auto)

- `auto` — выбрать профиль автоматически по CPU/RAM.
- `diagnostic` — быстрее, меньше файлов, меньше тяжёлых команд.
- `forensic` — максимально полный снимок (рекомендуется для «один раз собрать и потом разбирать»).

## Ресурсы и защита от перегруза

Инструмент старается не перегружать устройство:
- приоритет ниже обычного (`nice` для тяжёлых шагов);
- адаптивные паузы, если оценка загрузки CPU/памяти превышает лимиты:
  - CPU: ~85%
  - RAM: ~95%

Ограничения **best‑effort**: если другие процессы сами грузят CPU — инструмент будет ждать.

## Что получается на выходе

Вы получите архив вида:

`keenetic-maxprobe-<HOST>-<timestamp>.tar.gz`

Структура описана в `docs/OUTPUT_FORMAT.md`.

## Telegram‑уведомления (рекомендованная схема)

Keenetic OPKG поддерживает event‑хуки в `/opt/etc/ndm/*.d/` (WAN up/down, IP change, netfilter reload и др.).
Рекомендуемая практика для Telegram:
- хуки должны быть **очень быстрыми** (не блокировать систему);
- в хуке лучше **писать событие в очередь** (файл/spool), а отправку в Telegram делать отдельной Entware‑службой (daemon), чтобы не упереться в таймаут.

Инструмент в отчёте перечислит фактические директории хуков и предложит готовый шаблон.

См. также:
- https://support.keenetic.com (OPKG component description)
- https://help.keenetic.com (HTTP Proxy / RCI)

## Entware‑службы (единый слой)

В комплекте есть `scripts/entwarectl` — единый слой управления init‑скриптами Entware:
- список сервисов,
- start/stop/restart/status,
- просмотр логов (если есть).

## Поддержка / как прислать отчёт

Для анализа обычно достаточно:
- `analysis/REPORT_RU.md`
- `analysis/SENSITIVE_LOCATIONS.md`
- `meta/run.log`
- `meta/errors.log`

Если нужно — присылайте весь архив.
