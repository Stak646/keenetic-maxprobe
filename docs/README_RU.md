# keenetic-maxprobe — документация (RU)

## 1) Что это такое

`keenetic-maxprobe` делает **архив‑слепок** состояния роутера KeeneticOS и окружения Entware:
- конфиги (KeeneticOS / Entware),
- хуки событий `ndm` (OPKG),
- список сервисов `/opt/etc/init.d`,
- сетевые параметры (IP/route/rules/слушающие порты),
- доступность RCI/HTTP endpoints (локально/на интерфейсах),
- системные сведения (`/proc`, `ps`, `top`, `dmesg`, `mount`, `df`),
- подробные логи работы самого инструмента.

Инструмент **не изменяет конфигурацию роутера** (только читает и копирует).  
Исключение: может **временно** установить пакеты через `opkg` (если включено), а затем удалить их (best‑effort).

## 2) Режимы и профили

### MODE (что собирать + безопасность)
- `full` (по умолчанию): максимум данных, включая потенциально чувствительные.
- `safe`: часть наиболее рискованных файлов из зеркала удаляется/не копируется (best‑effort), но всё равно создаётся список чувствительных мест.
- `extream`: максимально глубокий сбор **без ограничений по чувствительной информации** (на практике: глубже зеркалирование FS + больше probes/эндпойнтов).

> В любом режиме создаётся `analysis/SENSITIVE_LOCATIONS.md` — карта, где **могут** быть секреты.

### PROFILE (насколько глубоко и «тяжело»)
- `auto` (рекомендуется): выбирается автоматически по CPU/RAM/свободному месту.
- `forensic`: максимально глубокий сбор (дольше, больше данных).
- `diagnostic`: компромисс.
- `lite`: минимум нагрузки/данных.

## 3) Ограничения по ресурсам (CPU/RAM)

По умолчанию включены лимиты (best‑effort):
- CPU <= **85%**
- RAM <= **95%**

Метрика CPU считается корректно по `/proc/stat` (0–100%).  
Метрика RAM — по `MemAvailable` (или fallback).

Параллельность (многозадачность) включается только там, где это безопасно (в основном для независимых collectors).

## 4) Установка

### One‑liner
```sh
sh -c "$(curl -fsSL https://raw.githubusercontent.com/Stak646/keenetic-maxprobe/main/scripts/install.sh)"
```

Установка кладёт:
- `/opt/bin/keenetic-maxprobe`
- `/opt/bin/entwarectl`
- `/opt/share/keenetic-maxprobe/collectors/*`

## 5) Запуск

### Базовый запуск (FULL, auto‑profile)
```sh
keenetic-maxprobe
```

### Экстремальный запуск (максимум)
```sh
keenetic-maxprobe --mode extream
```

### SAFE (минимизация секретов в зеркале)
```sh
keenetic-maxprobe --mode safe
```

### Язык интерфейса (приглашения мастера)
```sh
keenetic-maxprobe --lang ru   # по умолчанию
keenetic-maxprobe --lang en
```

### Параллельность collectors
```sh
keenetic-maxprobe --jobs auto
keenetic-maxprobe --jobs 2
```

### Лимиты ресурсов
```sh
keenetic-maxprobe --max-cpu 85 --max-mem 95
```

### Автоматическая «настройка» (wizard)
```sh
keenetic-maxprobe --init
```
Wizard создаёт `/opt/etc/keenetic-maxprobe.conf`.  
Если конфиг не нужен — не запускайте wizard: по умолчанию инструмент работает «на максимум» (FULL + auto‑profile).

## 6) Как читать архив и где что лежит

См. `docs/OUTPUT_FORMAT.md` (там есть дерево каталогов и назначение каждого файла).

Главная идея: **зеркало файловой системы** кладётся в `fs/`:
- оригинальный `/etc/...` → `fs/etc/...`
- оригинальный `/opt/etc/...` → `fs/opt/etc/...`
- оригинальный `/storage/...` → `fs/storage/...`

Это позволяет:
- быстро понять **откуда** файл,
- делать бэкапы/сравнения,
- восстанавливать отдельные сервисы Entware без полного сброса.

## 7) Чувствительные данные и редактирование перед отправкой

После сборки всегда создаются файлы:
- `analysis/SENSITIVE_LOCATIONS.md` — список файлов/строк, где могут быть секреты (без значений).
- `analysis/REDACTION_GUIDE_RU.md` — что и как скрывать перед отправкой.

Важно: в `full/extream` **архив может содержать**:
- пароли/ключи VPN,
- Wi‑Fi PSK,
- токены ботов,
- конфиги прокси, credentials и т.п.

Если вы отправляете архив кому‑то:
1) Пройдитесь по `analysis/SENSITIVE_LOCATIONS.md`.
2) Удалите/замаскируйте данные в соответствующих файлах `fs/...`.
3) Перепакуйте архив (или зашифруйте).

## 8) Web‑морды и API

Инструмент пытается:
- найти слушающие порты,
- определить какие порты отвечают по HTTP/HTTPS,
- сохранить заголовки/кусок тела ответа,
- подсказать какие endpoints реально существуют (коды 200/401/403/404).

Результаты:
- `net/listen_*` (порты)
- `net/http_probe.tsv` (быстрый probe по набору endpoint’ов)
- `web/` (расширенный probe в full/extream)

## 9) Хуки ndm и Telegram‑уведомления

KeeneticOS умеет запускать скрипты‑хуки из `*/etc/ndm/*.d`.  
OPKG‑пакеты часто добавляют свои хуки в `/opt/etc/ndm/...`.

Рекомендованная схема уведомлений в Telegram:
1) hook‑скрипт пишет событие в spool (например `/opt/var/spool/kmp/events.ndjson`);
2) отдельный Entware‑daemon читает spool и отправляет сообщения (rate‑limit);
3) управление daemon через `entwarectl restart`.

Инструмент:
- копирует хуки в `fs/.../etc/ndm/*.d`
- строит список найденных хуков в отчёте (Python‑анализатор)

## 10) Управление Entware‑службами

`entwarectl` — единый слой управления `/opt/etc/init.d`:
```sh
entwarectl list
entwarectl status <service>
entwarectl restart <service>
entwarectl enable <service>   # chmod +x
entwarectl disable <service>  # chmod -x
```

## 11) Troubleshooting

- **Мало места**: начиная с v0.7.0 вывод фиксирован в `/var/tmp`. Освободите место и/или перенесите итоговый архив после завершения на USB/Entware-диск. `--outdir` считается устаревшим и игнорируется (кроме `/var/tmp`).
- **opkg install не работает**: инструмент продолжит best‑effort; смотрите `meta/errors.log`.
- **python3 отсутствует**: отчёт всё равно будет, но менее умный; основной анализ делайте руками по `fs/`, `ndm/`, `net/`.



## Web UI

В **v0.7.0** добавлен простой Web-интерфейс для запуска сборов и просмотра статуса:

- показывает **phase/progress**, **CPU/RAM/loadavg**, tail лога,
- отображает список архивов и даёт кнопку скачать.

Запуск:

```sh
keenetic-maxprobe --web
```

По умолчанию слушает `127.0.0.1:8088` (локально на роутере).

Чтобы открыть из LAN (осторожно: отчёты могут содержать чувствительные данные):

```sh
keenetic-maxprobe --web --web-bind 0.0.0.0 --web-port 8088
```

Если Web UI не стартует из-за отсутствия Python3:

```sh
opkg update
opkg install python3
```

