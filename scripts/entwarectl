#!/bin/sh
# entwarectl â€” tiny unified control for /opt/etc/init.d services on Keenetic (Entware/OPKG)

set -eu

INITD="/opt/etc/init.d"

log() { printf '%s\n' "$*" >&2; }

usage() {
  cat >&2 <<'EOF'
Usage:
  entwarectl list
  entwarectl start <service>
  entwarectl stop <service>
  entwarectl restart <service>
  entwarectl status <service>
  entwarectl enable <service>     # chmod +x
  entwarectl disable <service>    # chmod -x
  entwarectl cat <service>        # print init script
EOF
}

have() { command -v "$1" >/dev/null 2>&1; }

resolve_service() {
  name="$1"

  # direct path
  if [ -f "$name" ]; then
    echo "$name"
    return 0
  fi

  # exact match in init.d
  if [ -f "$INITD/$name" ]; then
    echo "$INITD/$name"
    return 0
  fi

  for f in "$INITD"/S??*"$name"* "$INITD"/*"$name"*; do
    [ -f "$f" ] || continue
    echo "$f"
    return 0
  done

  return 1
}

cmd="${1:-}"
[ -n "$cmd" ] || { usage; exit 2; }

case "$cmd" in
  -h|--help|help) usage; exit 0 ;;
esac

case "$cmd" in
  list)
    [ -d "$INITD" ] || { log "[!] $INITD not found"; exit 1; }
    ls -1 "$INITD" 2>/dev/null || true
    ;;
  start|stop|restart|status|enable|disable|cat)
    svc="${2:-}"
    [ -n "$svc" ] || { usage; exit 2; }

    if ! path="$(resolve_service "$svc")"; then
      log "[!] Cannot resolve service: $svc"
      log "    Try: entwarectl list"
      exit 1
    fi

    case "$cmd" in
      enable)  chmod +x "$path"; log "[+] enabled: $path" ;;
      disable) chmod -x "$path"; log "[+] disabled: $path" ;;
      cat)     sed -n '1,240p' "$path" ;;
      status)
        if [ -x "$path" ]; then
          log "[i] script: $path (executable)"
        else
          log "[i] script: $path (NOT executable)"
        fi
        if have pgrep; then
          base="$(basename "$path")"
          name_guess="$(echo "$base" | sed -E 's/^S[0-9]+//')"
          pgrep -a "$name_guess" 2>/dev/null || true
        fi
        "$path" status 2>/dev/null || true
        ;;
      start|stop|restart)
        [ -x "$path" ] || { log "[!] Script not executable: $path"; exit 1; }
        "$path" "$cmd"
        ;;
    esac
    ;;
  *)
    usage
    exit 2
    ;;
esac
