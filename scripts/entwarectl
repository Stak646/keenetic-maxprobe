#!/bin/sh
# entwarectl â€” unified control for /opt/etc/init.d services (Entware/OPKG)
# Version: 0.6.0

set -eu

BASE="/opt/etc/init.d"

usage() {
  cat >&2 <<'USAGE'
usage:
  entwarectl list
  entwarectl status <service>
  entwarectl start <service>
  entwarectl stop <service>
  entwarectl restart <service>
  entwarectl enable <service>    # chmod +x
  entwarectl disable <service>   # chmod -x

notes:
  - service is the init script filename from /opt/etc/init.d
  - this is a thin wrapper intended for automation (e.g. Telegram bot)
USAGE
}

need_base() {
  [ -d "$BASE" ] || { echo "init.d not found: $BASE" >&2; exit 1; }
}

need_svc() {
  svc="$1"
  [ -n "$svc" ] || { usage; exit 2; }
  script="$BASE/$svc"
  [ -f "$script" ] || { echo "no such init script: $script" >&2; exit 1; }
}

cmd="${1:-}"
svc="${2:-}"

case "$cmd" in
  list)
    need_base
    ls -1 "$BASE" 2>/dev/null || true
    ;;

  enable)
    need_svc "$svc"
    chmod +x "$script" 2>/dev/null || true
    echo "enabled: $svc"
    ;;

  disable)
    need_svc "$svc"
    chmod -x "$script" 2>/dev/null || true
    echo "disabled: $svc"
    ;;

  start|stop|restart|status)
    need_svc "$svc"
    [ -x "$script" ] || { echo "script not executable (disabled?): $script" >&2; exit 1; }
    "$script" "$cmd"
    ;;

  ""|help|-h|--help)
    usage
    ;;

  *)
    echo "unknown command: $cmd" >&2
    usage
    exit 2
    ;;
esac
