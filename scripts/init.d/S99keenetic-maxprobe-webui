#!/bin/sh
### BEGIN INIT INFO
# Provides:          keenetic-maxprobe-webui
# Required-Start:    $local_fs $network
# Required-Stop:     $local_fs $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: keenetic-maxprobe Web UI
### END INIT INFO

set -u

CFG="/opt/etc/keenetic-maxprobe.conf"
PIDFILE="/opt/var/run/keenetic-maxprobe-webui.pid"
PORTFILE="/opt/var/run/keenetic-maxprobe-webui.port"
URLFILE="/opt/var/run/keenetic-maxprobe-webui.url"
LOG="/opt/var/log/keenetic-maxprobe-webui.log"

mkdir -p /opt/var/run /opt/var/log 2>/dev/null || true

have() { command -v "$1" >/dev/null 2>&1; }

load_cfg() {
  if [ -f "$CFG" ]; then
    # shellcheck disable=SC1090
    . "$CFG" 2>/dev/null || true
  fi

  WEB_BIND="${WEB_BIND:-0.0.0.0}"
  WEB_PORT="${WEB_PORT:-0}"
  LANG_UI="${LANG_UI:-ru}"
}

start() {
  load_cfg

  if [ -f "$PIDFILE" ]; then
    pid="$(cat "$PIDFILE" 2>/dev/null || true)"
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      echo "Already running (pid=$pid)"
      return 0
    fi
    rm -f "$PIDFILE" 2>/dev/null || true
  fi

  if ! have python3; then
    echo "python3 not found; Web UI cannot start"
    return 1
  fi

  rm -f "$PORTFILE" "$URLFILE" 2>/dev/null || true

  if [ "${WEB_PORT:-0}" = "0" ] 2>/dev/null; then
    echo "Starting Web UI on ${WEB_BIND}:auto (port=0) ..."
  else
    echo "Starting Web UI on ${WEB_BIND}:${WEB_PORT} ..."
  fi
  # Use the main CLI in web mode so it can auto-generate token and save config.
  nohup /opt/bin/keenetic-maxprobe --web --web-bind "$WEB_BIND" --web-port "$WEB_PORT" --lang "$LANG_UI" \
    >>"$LOG" 2>&1 &
  pid=$!
  echo "$pid" >"$PIDFILE"
  return 0
}

stop() {
  if [ ! -f "$PIDFILE" ]; then
    echo "Not running"
    return 0
  fi
  pid="$(cat "$PIDFILE" 2>/dev/null || true)"
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    echo "Stopping (pid=$pid) ..."
    kill "$pid" 2>/dev/null || true
    sleep 1
    kill -9 "$pid" 2>/dev/null || true
  fi
  rm -f "$PIDFILE" "$PORTFILE" "$URLFILE" 2>/dev/null || true
}

status() {
  if [ -f "$PIDFILE" ]; then
    pid="$(cat "$PIDFILE" 2>/dev/null || true)"
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
      echo "running (pid=$pid)"
      return 0
    fi
  fi
  echo "stopped"
  return 3
}

case "${1:-}" in
  start) start;;
  stop) stop;;
  restart) stop; start;;
  status) status;;
  *) echo "Usage: $0 {start|stop|restart|status}"; exit 2;;
esac
